<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Welcome to ImagingLSS’s documentation! &mdash; ImagingLSS 0.9 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="ImagingLSS 0.9 documentation" href="#" />
    <link rel="next" title="model package" href="model.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="model.html" title="model package"
             accesskey="N">next</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">ImagingLSS 0.9 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="welcome-to-imaginglss-s-documentation">
<h1>Welcome to ImagingLSS&#8217;s documentation!<a class="headerlink" href="#welcome-to-imaginglss-s-documentation" title="Permalink to this headline">¶</a></h1>
<p>Contents:</p>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<p>This is a data model of the DECAM imaging survey data
and potentially also for other desi targeting imaging survey,
for Large scale structure analysis.</p>
<p>The modelled data is a product from the Tractor, the source identification
software used in by DESI.</p>
<p>We have support on the <a class="reference external" href="https://desi.lbl.gov/trac/wiki/DecamLegacy/EDRfiles">Early Data Release (EDR) data</a>
and <a class="reference external" href="https://desi.lbl.gov/trac/wiki/DecamLegacy/DR1">DR1</a> .</p>
<p>To use this imaing data model on edison:</p>
<ol class="arabic simple">
<li>set environments</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">export </span><span class="nv">DECALS_IMAGING</span><span class="o">=</span>/global/project/projectdirs/cosmo/work/decam/release/edr/
<span class="nb">export </span><span class="nv">DECALS_CACHE</span><span class="o">=</span><span class="nv">$GSCRATCH</span>/desicache
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>install astropy or fitsio (prefered)</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre>easy_install --user fitsio
</pre></div>
</div>
<p>or</p>
<div class="highlight-bash"><div class="highlight"><pre>easy_install --user astropy
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>try if usecase.py runs.</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre>python usecase.py
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>start hacking with</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre>from model.datarelease import DataRelease
<span class="nv">dr</span> <span class="o">=</span> DataRelease<span class="o">()</span>
</pre></div>
</div>
<p>Due to internal caching of the catalogue, the running time is faster after first time.</p>
<p>Documentation of the modelling can be seen in model/README.md</p>
<p>We are working on a more comprehensive documentation generated from
source code doc strings. The current version of the document is at</p>
<p><a class="reference external" href="http://desihub.github.io/imaginglss">http://desihub.github.io/imaginglss</a></p>
<div class="section" id="known-issues">
<h2>Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this headline">¶</a></h2>
<p>If the data release has updated (rare but it happened),
and the cache files are out of date.
Run forget_cache.py to clear the cache.</p>
</div>
<div class="section" id="description-of-model-used-to-process-decals-imaging-data">
<h2>Description of model used to process DECALS imaging data.<a class="headerlink" href="#description-of-model-used-to-process-decals-imaging-data" title="Permalink to this headline">¶</a></h2>
<p>The DECALS imaging data are processed in &#8220;Brick&#8221;s on the sky,
each Brick being a small, contiguous regions of sky (roughly
0.5x0.5 degrees).  The data, including information on depths,
extinction, etc. are stored in pixelized images within the
FITS files.  There are also catalogs of objects, produced by
Tractor, which are associated with each brick.</p>
<p>The main way to access the DECALS imaging data is via DataRelease
objects defined in <a class="reference internal" href="model.datarelease.html#model.datarelease.DataRelease" title="model.datarelease.DataRelease"><code class="xref py py-class docutils literal"><span class="pre">model.datarelease.DataRelease</span></code></a>.
Important attributes are</p>
<blockquote>
<div><ul class="simple">
<li><code class="xref py py-attr docutils literal"><span class="pre">footprint</span></code> : the survey footprint.</li>
<li><code class="xref py py-attr docutils literal"><span class="pre">brickindex</span></code>: the Brick geometry (BrickIndex)</li>
<li><code class="xref py py-attr docutils literal"><span class="pre">images</span></code>    : the images released in the DR</li>
<li><code class="xref py py-attr docutils literal"><span class="pre">catalogue</span></code> : the imaging catalogue reported by tractor</li>
</ul>
</div></blockquote>
<p>The member methods are</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="model.datarelease.html#model.datarelease.DataRelease.readout" title="model.datarelease.DataRelease.readout"><code class="xref py py-meth docutils literal"><span class="pre">readout()</span></code></a>   : reading out pixel value of an image
for coordinates on the sky.</li>
</ul>
</div></blockquote>
<p>Catalog information is handled by <code class="xref py py-class docutils literal"><span class="pre">model.datarelease.catalog.Catalogue</span></code>, which stores the
object catalogs associated with a data release.
The catalogs are contained in many small FITS files,
but this class caches the
information for speed and only columns that are accessed are loaded
into memory. Use &#8216;forget_cache.py&#8217; to clear this cache.</p>
<p>The images are represented by <a class="reference internal" href="model.imagerepo.html#model.imagerepo.ImageRepo" title="model.imagerepo.ImageRepo"><code class="xref py py-class docutils literal"><span class="pre">model.imagerepo.ImageRepo</span></code></a> objects.
An ImageRepo object takes care of reading the image tile of a Brick.
An image tile contains a padded region around the Brick,
which is sometimes mentioned as a margin, a padding, or a bleeding region.</p>
<p>A DataRelease has several image repositories, for example,</p>
<blockquote>
<div><ul class="simple">
<li>DataRelease.images[&#8216;depth&#8217;][&#8216;u&#8217;] : the &#8216;u&#8217; band inverse variance depth images</li>
<li>DataRelease.images[&#8216;image&#8217;][&#8216;u&#8217;] : the coadded &#8216;u&#8217; band image in nanomaggies</li>
<li>DataRelease.images[&#8216;model&#8217;][&#8216;u&#8217;] : the model &#8216;u&#8217; band image in nanomaggies;</li>
</ul>
</div></blockquote>
<p><a class="reference internal" href="model.brick.html#model.brick.Brick" title="model.brick.Brick"><code class="xref py py-class docutils literal"><span class="pre">model.brick.Brick</span></code></a> holds metadata for each Brick, including the central
<code class="xref py py-attr docutils literal"><span class="pre">ra</span></code>, <code class="xref py py-attr docutils literal"><span class="pre">dec</span></code>,
and the primary area(
<code class="xref py py-attr docutils literal"><span class="pre">ra1</span></code>, <code class="xref py py-attr docutils literal"><span class="pre">dec1</span></code>,
<code class="xref py py-attr docutils literal"><span class="pre">ra2</span></code>, <code class="xref py py-attr docutils literal"><span class="pre">dec2</span></code>
) covered by the brick, excluding the padding region.
There are routines for converting from sky coordinates to image
pixels within each brick, and routines for querying the images
handled by imagerepo.</p>
<p><a class="reference internal" href="model.brickindex.html#model.brickindex.BrickIndex" title="model.brickindex.BrickIndex"><code class="xref py py-class docutils literal"><span class="pre">model.brickindex.BrickIndex</span></code></a> holds the metadata
of of the brick decomposition scheme.
There are routines for converting from
sky coordinates to bricks, and acts as a factory that creates
<a class="reference internal" href="model.brick.html#model.brick.Brick" title="model.brick.Brick"><code class="xref py py-class docutils literal"><span class="pre">Brick</span></code></a> objects.</p>
<div class="section" id="helper-routines">
<h3>Helper routines<a class="headerlink" href="#helper-routines" title="Permalink to this headline">¶</a></h3>
<p>In order to reduce the number of dependecies,
we implemented a few coordinate transformations</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="model.utils.wcs_tangent.html#module-model.utils.wcs_tangent" title="model.utils.wcs_tangent"><code class="xref py py-mod docutils literal"><span class="pre">model.utils.wcs_tangent</span></code></a> impments the WCS tangent format.</li>
<li><a class="reference internal" href="model.utils.wcs_simplezea.html#module-model.utils.wcs_simplezea" title="model.utils.wcs_simplezea"><code class="xref py py-mod docutils literal"><span class="pre">model.utils.wcs_simplezea</span></code></a> implement the WCS ZEA format; oriented at north / south pole</li>
<li><a class="reference internal" href="model.utils.euler.html#module-model.utils.euler" title="model.utils.euler"><code class="xref py py-mod docutils literal"><span class="pre">model.utils.euler</span></code></a> implements the transformation between Galactic and RA/DEC. coordinates.</li>
</ul>
</div></blockquote>
<p>Examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># Generates random points within the footprint based</span>
<span class="c"># on a chosen selection (e.g. LRG, ELG or QSO).</span>
<span class="c">#</span>
<span class="c"># There are two ways we could do this ... first we could</span>
<span class="c"># generate a large number of randoms and store the</span>
<span class="c"># properties required for target selection per random.</span>
<span class="c"># Then a query on this file would return randoms appropriate</span>
<span class="c"># for whatever selection is desired.</span>
<span class="c"># Alternatively we could impose the cuts before writing the</span>
<span class="c"># files, thus generating specific randoms &quot;at once&quot;.</span>
<span class="c"># This code takes the latter approach, while &quot;mpirandom&quot; takes</span>
<span class="c"># the former approach.</span>
<span class="c">#</span>
<span class="c"># Currently this code uses OpenMP parallelization, the switch to</span>
<span class="c"># using MPI is relatively straightforward.</span>
<span class="c">#</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span><span class="n">division</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Yu Feng and Martin White&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span>
<span class="n">__email__</span>  <span class="o">=</span> <span class="s">&quot;yfeng1@berkeley.edu or mjwhite@lbl.gov&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span>             <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">from</span>   <span class="nn">model.utils</span>       <span class="kn">import</span> <span class="n">sharedmem</span>
<span class="kn">from</span>   <span class="nn">model.sfdmap</span>      <span class="kn">import</span> <span class="n">SFDMap</span>
<span class="kn">from</span>   <span class="nn">model.datarelease</span> <span class="kn">import</span> <span class="n">DataRelease</span>
<span class="kn">import</span> <span class="nn">cuts</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c">#from mpi4py            import MPI</span>

<span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">fill_random</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">Nran</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="mi">999993</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fill_random(dr,Nran,seed=999993): </span>
<span class="sd">    Generate uniformly distributed points within the boundary that lie in</span>
<span class="sd">    bricks.  We generate in the ra/dec area, then remove points not in any</span>
<span class="sd">    bricks.  This hugely increases the memory efficiency for footprints,</span>
<span class="sd">    like DR1, where the survey covers several disjoint patches of the sky.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">ramin</span><span class="p">,</span><span class="n">ramax</span><span class="p">,</span><span class="n">dcmin</span><span class="p">,</span><span class="n">dcmax</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">footprint</span><span class="o">.</span><span class="n">range</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">Nran</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">start</span> <span class="o">!=</span> <span class="n">Nran</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">sharedmem</span><span class="o">.</span><span class="n">MapReduce</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="c"># prepare for a parallel section.</span>
            <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">512</span>
            <span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">32</span><span class="p">))</span>
            <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="c"># Find my slice</span>
                <span class="n">myu1</span> <span class="o">=</span> <span class="n">u1</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunksize</span><span class="p">]</span>
                <span class="n">myu2</span> <span class="o">=</span> <span class="n">u2</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunksize</span><span class="p">]</span>
                <span class="c">#</span>
                <span class="n">cmin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dcmin</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
                <span class="n">cmax</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dcmax</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
                <span class="c">#</span>
                <span class="n">RA</span>   <span class="o">=</span> <span class="n">ramin</span> <span class="o">+</span> <span class="n">myu1</span><span class="o">*</span><span class="p">(</span><span class="n">ramax</span><span class="o">-</span><span class="n">ramin</span><span class="p">)</span>
                <span class="n">DEC</span>  <span class="o">=</span> <span class="mi">90</span><span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cmin</span><span class="o">+</span><span class="n">myu2</span><span class="o">*</span><span class="p">(</span><span class="n">cmax</span><span class="o">-</span><span class="n">cmin</span><span class="p">))</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">pi</span>
                <span class="c"># Filter out those not in any bricks: only very few points remain</span>
                <span class="n">coord1</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">footprint</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">RA</span><span class="p">,</span> <span class="n">DEC</span><span class="p">))</span>
                <span class="k">return</span><span class="p">(</span><span class="n">coord1</span><span class="p">)</span>
            <span class="c"># Run; the number here is just make sure each batch won&#39;t </span>
            <span class="c"># use too much memory</span>
            <span class="n">coord1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">32</span><span class="p">,</span><span class="n">chunksize</span><span class="p">)),</span>
                    <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># Are we full?</span>
        <span class="n">coord1</span> <span class="o">=</span> <span class="n">coord1</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">Nran</span> <span class="o">-</span> <span class="n">start</span><span class="p">)]</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">coord</span><span class="p">[:,</span> <span class="n">sl</span><span class="p">]</span> <span class="o">=</span> <span class="n">coord1</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">Nran</span><span class="p">,</span> <span class="s">&#39;filled&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dr</span><span class="o">.</span><span class="n">brickindex</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">coord</span><span class="p">)))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="o">.</span><span class="n">footprint</span><span class="o">.</span><span class="n">bricks</span><span class="p">):</span>
        <span class="c"># If this happens, we don&#39;t have enough points to cover the foot print</span>
        <span class="c"># fairly. Some bricks have no random points.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Too few random points, increase Nran&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coord</span>




<span class="k">def</span> <span class="nf">apply_samp_cut</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">sfd</span><span class="p">,</span> <span class="n">samp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    apply_samp_cut(coord, dr, sfd, samp): </span>
<span class="sd">    Apply the cuts for sample &quot;samp&quot;.  This logic is sufficiently complex it</span>
<span class="sd">    is worth having in its own routine.</span>
<span class="sd">    Returns ww (indices of good samples), rmag (r band mag)</span>
<span class="sd">    Currently this applies cuts for the &quot;100%&quot; complete sample, i.e. assuming</span>
<span class="sd">    the LF is a delta function at the faint end cut.  This avoids needing</span>
<span class="sd">    to know the LF for now.  Later we could keep a fraction of the randoms</span>
<span class="sd">    based on the survey limit (and the LF) or we could produce randoms for</span>
<span class="sd">    &quot;100%&quot; complete samples of different luminosity thresholds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Work out which points pass the cuts -- most of this work is handled</span>
    <span class="c"># by calls to &quot;cuts&quot;.</span>
    <span class="k">if</span> <span class="n">samp</span><span class="o">==</span><span class="s">&quot;LRG&quot;</span><span class="p">:</span>
        <span class="n">rlim</span><span class="p">,</span><span class="n">zlim</span><span class="p">,</span><span class="n">wlim</span> <span class="o">=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">findlim</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">sfd</span><span class="p">,</span><span class="n">coord</span><span class="p">,[</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="s">&#39;W1&#39;</span><span class="p">])</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">Completeness</span><span class="o">.</span><span class="n">LRG</span><span class="p">(</span><span class="n">rlim</span><span class="p">,</span><span class="n">zlim</span><span class="p">,</span><span class="n">wlim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">samp</span><span class="o">==</span><span class="s">&quot;ELG&quot;</span><span class="p">:</span>
        <span class="n">glim</span><span class="p">,</span><span class="n">rlim</span><span class="p">,</span><span class="n">zlim</span> <span class="o">=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">findlim</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">sfd</span><span class="p">,</span><span class="n">coord</span><span class="p">,[</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">])</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">Completeness</span><span class="o">.</span><span class="n">ELG</span><span class="p">(</span><span class="n">glim</span><span class="p">,</span><span class="n">rlim</span><span class="p">,</span><span class="n">zlim</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">samp</span><span class="o">==</span><span class="s">&quot;QSO&quot;</span><span class="p">:</span>
        <span class="n">glim</span><span class="p">,</span><span class="n">rlim</span><span class="p">,</span><span class="n">w1lim</span><span class="p">,</span><span class="n">w2lim</span> <span class="o">=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">findlim</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">sfd</span><span class="p">,</span><span class="n">coord</span><span class="p">,[</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;W1&#39;</span><span class="p">,</span><span class="s">&#39;W2&#39;</span><span class="p">])</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">Completeness</span><span class="o">.</span><span class="n">QSO</span><span class="p">(</span><span class="n">glim</span><span class="p">,</span><span class="n">rlim</span><span class="p">,</span><span class="n">w1lim</span><span class="p">,</span><span class="n">w2lim</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span><span class="s">&quot;Unknown sample &quot;</span><span class="o">+</span><span class="n">samp</span>
    <span class="n">ww</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c"># It&#39;s also useful to have r magnitude later.</span>
    <span class="n">rmag</span> <span class="o">=</span> <span class="mf">22.5</span><span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">rlim</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">1e-15</span><span class="p">,</span><span class="mf">1e15</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span><span class="n">rmag</span><span class="p">)</span> <span class="p">)</span>
    <span class="c">#</span>



<span class="k">def</span> <span class="nf">make_random</span><span class="p">(</span><span class="n">samp</span><span class="p">,</span><span class="n">Nran</span><span class="o">=</span><span class="mi">10000000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    make_random(samp,Nran=1000000)</span>
<span class="sd">    Does the work of making randoms.  The sample type is passed as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">samp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;LRG&quot;</span><span class="p">,</span><span class="s">&quot;ELG&quot;</span><span class="p">,</span><span class="s">&quot;QSO&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span><span class="s">&quot;Unknown sample &quot;</span><span class="o">+</span><span class="n">samp</span>
    <span class="c"># Get the total footprint bounds, to throw randoms within, and an E(B-V)</span>
    <span class="c"># map instance.</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">DataRelease</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s">&#39;DR1&#39;</span><span class="p">)</span> <span class="c">#, _covered_brickids=subset)</span>
    <span class="n">sfd</span><span class="o">=</span> <span class="n">SFDMap</span><span class="p">(</span><span class="n">dustdir</span><span class="o">=</span><span class="s">&quot;/project/projectdirs/desi/software/edison/dust/v0_0/&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Making randoms in the survey footprint.&#39;</span><span class="p">)</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">fill_random</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">Nran</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="c"># The call to optimize reorders the array to be brick-ordered.</span>
    <span class="c"># Read out is faster this way</span>
    <span class="n">coord</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">brickindex</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
    <span class="n">bid</span>   <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">brickindex</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Have </span><span class="si">%d</span><span class="s"> unique bricks&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bid</span><span class="p">)))</span>
    <span class="c">#</span>
    <span class="k">with</span> <span class="n">sharedmem</span><span class="o">.</span><span class="n">MapReduce</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="c"># prepare a parallel section</span>
        <span class="n">chunksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">np</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># purge the file once for all</span>
        <span class="n">fout</span>  <span class="o">=</span> <span class="s">&quot;randoms_</span><span class="si">%s</span><span class="s">.rdz&quot;</span><span class="o">%</span><span class="n">samp</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c"># Work out which points belong on which slice.</span>
            <span class="n">mycoord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[:,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunksize</span><span class="p">]</span>
            <span class="c"># Apply the cut for sample type on my slice</span>
            <span class="n">ww</span><span class="p">,</span><span class="n">rmag</span> <span class="o">=</span> <span class="n">apply_samp_cut</span><span class="p">(</span><span class="n">mycoord</span><span class="p">,</span><span class="n">dr</span><span class="p">,</span><span class="n">sfd</span><span class="p">,</span><span class="n">samp</span><span class="p">)</span>
            <span class="c"># Notify user this slice is done</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="k">return</span><span class="p">(</span> <span class="p">(</span><span class="n">mycoord</span><span class="p">,</span><span class="n">ww</span><span class="p">,</span><span class="n">rmag</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="n">mycoord</span><span class="p">,</span> <span class="n">ww</span><span class="p">,</span> <span class="n">rmag</span><span class="p">):</span>
            <span class="c"># and take turns writing this out:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fout</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ww</span><span class="p">:</span>
                    <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%15.10f</span><span class="s"> </span><span class="si">%15.10f</span><span class="s"> </span><span class="si">%15.10f</span><span class="s"> </span><span class="si">%15.10f</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span>\
                      <span class="p">(</span><span class="n">mycoord</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="n">mycoord</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mf">0.5</span><span class="p">,</span><span class="n">rmag</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">ww</span><span class="p">)</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">work</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="n">chunksize</span><span class="p">),</span><span class="nb">reduce</span><span class="o">=</span><span class="nb">reduce</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Total area (sq.deg.) &#39;</span><span class="p">,</span><span class="n">dr</span><span class="o">.</span><span class="n">footprint</span><span class="o">.</span><span class="n">area</span><span class="o">*</span><span class="mf">1.0</span><span class="o">*</span><span class="n">total</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Done!&#39;</span><span class="p">)</span>
    <span class="c">#</span>


 
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>    
    <span class="k">for</span> <span class="n">samp</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;ELG&quot;</span><span class="p">]:</span>
        <span class="n">make_random</span><span class="p">(</span><span class="n">samp</span><span class="p">,</span> <span class="n">Nran</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span>
    <span class="c">#</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># Code to select ELG targets from Tractor catalogs.</span>
<span class="c"># The target selection criteria are described at:</span>
<span class="c">#   https://desi.lbl.gov/trac/wiki/TargetSelection</span>
<span class="c">#</span>
<span class="c"># These catalogs also need to be vetod using the</span>
<span class="c"># depths and masks which are part of Tractor, since</span>
<span class="c"># catalog entries can appear in places where the</span>
<span class="c"># nominal depth is insufficient to be complete.</span>
<span class="c">#</span>
<span class="c"># Usage: python select_elg.py [--plot]</span>
<span class="c">#</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Yu Feng and Martin White&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span>
<span class="n">__email__</span>  <span class="o">=</span> <span class="s">&quot;yfeng1@berkeley.edu or mjwhite@lbl.gov&quot;</span>



<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">from</span> <span class="nn">model.utils</span>       <span class="kn">import</span> <span class="n">sharedmem</span>
<span class="kn">from</span> <span class="nn">model.sfdmap</span>      <span class="kn">import</span> <span class="n">SFDMap</span>
<span class="kn">from</span> <span class="nn">model.datarelease</span> <span class="kn">import</span> <span class="n">DataRelease</span>
<span class="kn">import</span> <span class="nn">cuts</span>





<span class="k">def</span> <span class="nf">select_elgs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    select_elgs()</span>
<span class="sd">    Does the actual selection, imposing cuts on the fluxes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get instances of a data release and SFD dust map.</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">DataRelease</span><span class="p">()</span>
    <span class="n">sfd</span><span class="o">=</span> <span class="n">SFDMap</span><span class="p">(</span><span class="n">dustdir</span><span class="o">=</span><span class="s">&quot;/project/projectdirs/desi/software/edison/dust/v0_0/&quot;</span><span class="p">)</span>
    <span class="c"># Define the fluxes, corrected for MW transmission.</span>
    <span class="n">flux</span>  <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">catalogue</span><span class="p">[</span><span class="s">&#39;DECAM_FLUX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">trn</span>   <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">catalogue</span><span class="p">[</span><span class="s">&#39;DECAM_MW_TRANSMISSION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">GFLUX</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">trn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">RFLUX</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">trn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ZFLUX</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">/</span> <span class="n">trn</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="c"># Now do the selection ...</span>
    <span class="n">primary</span><span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">catalogue</span><span class="p">[</span><span class="s">&#39;BRICK_PRIMARY&#39;</span><span class="p">]</span>
    <span class="n">mask</span>   <span class="o">=</span> <span class="p">(</span><span class="n">primary</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span>  <span class="o">&amp;=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">Fluxes</span><span class="o">.</span><span class="n">ELG</span><span class="p">(</span><span class="n">gflux</span><span class="o">=</span><span class="n">GFLUX</span><span class="p">,</span><span class="n">rflux</span><span class="o">=</span><span class="n">RFLUX</span><span class="p">,</span><span class="n">zflux</span><span class="o">=</span><span class="n">ZFLUX</span><span class="p">)</span>
    <span class="c"># ... and extract only the objects which passed the cuts.</span>
    <span class="c"># At this point we convert fluxes to (extinction corrected)</span>
    <span class="c"># magnitudes, ignoring errors.</span>
    <span class="n">ra</span>   <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">catalogue</span><span class="p">[</span> <span class="s">&#39;RA&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">dc</span>   <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">catalogue</span><span class="p">[</span><span class="s">&#39;DEC&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">mag</span>  <span class="o">=</span> <span class="mf">22.5</span><span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">N</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="p">(</span><span class="n">flux</span><span class="p">[:,</span><span class="n">mask</span><span class="p">]</span><span class="o">/</span><span class="n">trn</span><span class="p">[:,</span><span class="n">mask</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">1e-15</span><span class="p">,</span><span class="mf">1e15</span><span class="p">)</span> <span class="p">)</span>
    <span class="c"># Now we need to pass this through our mask since galaxies can</span>
    <span class="c"># appear even in regions where our nominal depth is insufficient</span>
    <span class="c"># for a complete sample.</span>
    <span class="k">with</span> <span class="n">sharedmem</span><span class="o">.</span><span class="n">MapReduce</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="p">(</span><span class="n">RA</span><span class="p">,</span><span class="n">DEC</span><span class="p">),</span><span class="n">arg</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">brickindex</span><span class="o">.</span><span class="n">optimize</span><span class="p">((</span><span class="n">ra</span><span class="p">,</span><span class="n">dc</span><span class="p">),</span><span class="n">return_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">RA</span><span class="p">)),</span> 
            <span class="n">coord</span> <span class="o">=</span> <span class="p">(</span><span class="n">RA</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunksize</span><span class="p">],</span><span class="n">DEC</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunksize</span><span class="p">])</span>
            <span class="n">lim</span> <span class="o">=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">findlim</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">sfd</span><span class="p">,</span><span class="n">coord</span><span class="p">,[</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>
        <span class="c"># the ordering is the same as the call to findlim</span>
        <span class="n">glim</span><span class="p">,</span><span class="n">rlim</span><span class="p">,</span><span class="n">zlim</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>\
            <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">work</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">RA</span><span class="p">),</span><span class="n">chunksize</span><span class="p">)),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cuts</span><span class="o">.</span><span class="n">Completeness</span><span class="o">.</span><span class="n">ELG</span><span class="p">(</span><span class="n">glim</span><span class="o">=</span><span class="n">glim</span><span class="p">,</span><span class="n">rlim</span><span class="o">=</span><span class="n">rlim</span><span class="p">,</span><span class="n">zlim</span><span class="o">=</span><span class="n">zlim</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ww</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">ra</span>   <span class="o">=</span> <span class="n">RA</span><span class="p">[</span> <span class="n">ww</span><span class="p">]</span>
        <span class="n">dc</span>   <span class="o">=</span> <span class="n">DEC</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span>
        <span class="n">mag</span>  <span class="o">=</span> <span class="n">mag</span><span class="p">[:,</span><span class="n">arg</span><span class="p">[</span><span class="n">ww</span><span class="p">]]</span>
    <span class="k">return</span><span class="p">(</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">mag</span><span class="p">)</span> <span class="p">)</span>
    <span class="c">#</span>




<span class="k">def</span> <span class="nf">diagnostic_plots</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span><span class="n">dec</span><span class="p">,</span><span class="n">mag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    diagnostic_plots(ra,dec,mag):</span>
<span class="sd">    Makes some &quot;useful&quot; diagnostic plots.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="kn">import</span> <span class="n">FigureCanvasAgg</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvasAgg</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;elg-ra-dec.png&#39;</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span> <span class="o">-</span> <span class="n">z</span><span class="p">,</span> <span class="s">&#39;. &#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">23.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;r &lt; 0.3&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;(r-z) &gt; 0.3&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;(r-z) &lt; 1.5&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Intrinsic z&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Intrinsic r-z&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvasAgg</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;elg-ri-rz.png&#39;</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="p">(</span><span class="n">g</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="p">(</span><span class="n">g</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span> <span class="o">-</span> <span class="n">z</span><span class="p">,</span> <span class="s">&#39;. &#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;(g-r) &lt; (r-z) - 0.2&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.2</span> <span class="o">-</span> <span class="n">x</span> <span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;(g-r) &gt; 1.2 - (r-z)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Intrinsic g-r&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Intrinsic r-z&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvasAgg</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">&#39;elg-gr-rz.png&#39;</span><span class="p">)</span>
    <span class="c">#</span>




<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>
    <span class="c">#</span>
    <span class="n">ra</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">mag</span> <span class="o">=</span> <span class="n">select_elgs</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;--plot&#39;</span><span class="p">:</span>
        <span class="n">diagnostic_plots</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">mag</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Just write the sample to an ascii text file.</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;elgs.rdz&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;# </span><span class="si">%13s</span><span class="s"> </span><span class="si">%15s</span><span class="s"> </span><span class="si">%15s</span><span class="s"> </span><span class="si">%15s</span><span class="s"> </span><span class="si">%15s</span><span class="s"> </span><span class="si">%15s</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span>\
          <span class="p">(</span><span class="s">&quot;RA&quot;</span><span class="p">,</span><span class="s">&quot;DEC&quot;</span><span class="p">,</span><span class="s">&quot;PhotoZ&quot;</span><span class="p">,</span><span class="s">&quot;g&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">,</span><span class="s">&quot;z&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ra</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%15.10f</span><span class="s"> </span><span class="si">%15.10f</span><span class="s"> </span><span class="si">%15.10f</span><span class="s"> </span><span class="si">%15.10f</span><span class="s"> </span><span class="si">%15.10f</span><span class="s"> </span><span class="si">%15.10f</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span>\
              <span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mf">0.5</span><span class="p">,</span><span class="n">mag</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">mag</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="n">mag</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c">#</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>#PBS -S /bin/bash
#PBS -l mppwidth=24,walltime=00:05:00
#PBS -N Example
#PBS -o Example.out
#PBS -e Example.err
#PBS -q debug
#PBS -A m779
#
# An example &quot;submit&quot; script, to work on Edison at NERSC,
# to read a catalog of Decals objects and print some
# basic statics about them.
#
cd $PBS_O_WORKDIR
#
# Load the modules we need.
source /project/projectdirs/desi/software/modules/desi_environment.sh
#
# Set the path to the imaging data.
export DECALS_IMAGING=/project/projectdirs/cosmo/work/decam/cats/edr3
export DECALS_IMAGING=/project/projectdirs/cosmo/work/decam/release/edr/
export DECALS_IMAGING=/project/projectdirs/cosmo/work/decam/release/dr1/
export DECALS_CACHE=$GSCRATCH/desicache
#
# and set up the Python path...this is an example.
export PYTHONPATH=${PYTHONPATH}:${PBS_O_WORKDIR}
#
export OMP_NUM_THREADS=24
aprun -n 1 -d 24 python &lt;&lt; EOF
from model.datarelease import DataRelease
dr    = DataRelease()
foot  = dr.footprint
print foot
EOF
#
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="modules">
<h1>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="model">
<h1>model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="model.html">model package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="model.html#subpackages">Subpackages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="model.utils.html">model.utils package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="model.utils.html#submodules">Submodules</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="model.html#submodules">Submodules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="model.brick.html">model.brick module</a></li>
<li class="toctree-l3"><a class="reference internal" href="model.brickindex.html">model.brickindex module</a></li>
<li class="toctree-l3"><a class="reference internal" href="model.catalogue.html">model.catalogue module</a></li>
<li class="toctree-l3"><a class="reference internal" href="model.datarelease.html">model.datarelease module</a></li>
<li class="toctree-l3"><a class="reference internal" href="model.imagerepo.html">model.imagerepo module</a></li>
<li class="toctree-l3"><a class="reference internal" href="model.schema.html">model.schema module</a></li>
<li class="toctree-l3"><a class="reference internal" href="model.sfdmap.html">model.sfdmap module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span>Index</span></a></li>
<li><a class="reference internal" href="py-modindex.html"><span>Module Index</span></a></li>
<li><a class="reference internal" href="search.html"><span>Search Page</span></a></li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Welcome to ImagingLSS&#8217;s documentation!</a><ul>
<li><a class="reference internal" href="#known-issues">Known Issues</a></li>
<li><a class="reference internal" href="#description-of-model-used-to-process-decals-imaging-data">Description of model used to process DECALS imaging data.</a><ul>
<li><a class="reference internal" href="#helper-routines">Helper routines</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#modules">Modules</a></li>
<li><a class="reference internal" href="#model">model</a></li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>

  <h4>Next topic</h4>
  <p class="topless"><a href="model.html"
                        title="next chapter">model package</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="model.html" title="model package"
             >next</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">ImagingLSS 0.9 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Yu Feng, Martin White.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.
    </div>
  </body>
</html>