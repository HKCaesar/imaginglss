<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Usage: Data Pipeline &mdash; ImagingLSS 0.9 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="ImagingLSS 0.9 documentation" href="index.html" />
    <link rel="next" title="Data Model" href="datamodel.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="datamodel.html" title="Data Model"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ImagingLSS 0.9 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="usage-data-pipeline">
<h1>Usage: Data Pipeline<a class="headerlink" href="#usage-data-pipeline" title="Permalink to this headline">¶</a></h1>
<p>The primary usage of ImagingLSS is to produce large scale structure catalogues.
In this section, we document the data pipeline. There are the steps:</p>
<ul class="simple">
<li>Building the cache</li>
<li>Generating the object catalogue</li>
<li>Generating the random sampling of the mask,
or Querying depth for given RA DEC positions</li>
<li>Applying veto based on proximity to stars</li>
<li>Estimating completeness for randoms and objects</li>
<li>Assemble and export final text files</li>
</ul>
<p>The first 3 steps are computational/data extensive and we provide mpi4py based
scripts; which shall go through the job queue of a computing facility.</p>
<p>The rest of the steps are very light weight and the head nodes can easily handle them.</p>
<p>We will cover them in the following sections. The examples are based off our
working configuration at NERSC.</p>
<p>The source file <cite>runtests.sh</cite> in the root directory
contains an example of the full pipeline for producing randoms
and objects of the QSO target type.</p>
<div class="section" id="building-the-cache">
<h2>Building the Cache<a class="headerlink" href="#building-the-cache" title="Permalink to this headline">¶</a></h2>
<p>Before we start using ImagingLSS, it is crucial to build the catalogue cache.</p>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">On Edison for DR2, this step can be omitted
if the following configuration file is used:</p>
</div>
<p>The application to build the cache is <code class="code docutils literal"><span class="pre">scripts/imglss-mpi-build-cache.py</span></code>. The application
scans the files in the data release described by a configuration file (provided in
<code class="code docutils literal"><span class="pre">--conf</span></code> argument), and converts the columns used by ImagingLSS to a binary
format that is much easier to use into the &#8216;cache&#8217; directory specified in the configuration
file. For the format of the configuration file, refer to <cite>Configuration File</cite>.</p>
<p>The inline help of the script describes the usage:</p>
<div class="highlight-bash"><div class="highlight"><pre>usage: imglss-mpi-build-cache.py <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--conf CONF<span class="o">]</span>

optional arguments:
  -h, --help   show this <span class="nb">help </span>message and <span class="nb">exit</span>
  --conf CONF  Path to the imaginglss config file, default is from
               DECALS_PY_CONFIG
</pre></div>
</div>
<p>Here is an example job script that works on Edison (Note that python-mpi-bcast is used).
Submit the job script with <code class="code docutils literal"><span class="pre">sbatch</span></code>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH -J imglss-mpi-build-cache</span>
<span class="c">#SBATCH -n 512</span>
<span class="c">#SBATCH -o imglss-mpi-build-cache.%j</span>
<span class="c">#SBATCH -p debug</span>
<span class="c">#SBATCH -t 00:30:00</span>

<span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span>1

module load python/2.7-anaconda
<span class="nb">source</span> /project/projectdirs/m779/python-mpi/nersc/activate.sh

<span class="c"># change the following line to where your ImagingLSS is installed</span>
mirror ~/source/imaginglss imaginglss scripts

<span class="c"># change conf to your imaginglss configuration file</span>
srun -n <span class="m">256</span> python-mpi /dev/shm/local/scripts/imglss-mpi-build-cache.py --conf /project/projectdirs/m779/imaginglss/dr2.conf.py
</pre></div>
</div>
</div>
<div class="section" id="generating-object-catalogue">
<h2>Generating Object Catalogue<a class="headerlink" href="#generating-object-catalogue" title="Permalink to this headline">¶</a></h2>
<p><code class="code docutils literal"><span class="pre">scripts/imglss-mpi-select-objects.py</span></code> selects objects of a type, and writes out the objects
that we will use in the later stages of the pipeline.</p>
<p>The target types are defined at <a class="reference external" href="http://desi.lbl.gov/trac/wiki/TargetSelection">http://desi.lbl.gov/trac/wiki/TargetSelection</a></p>
<p>The output is the RA DEC and magnitudes of objects.</p>
<p>The inline help of the script describes the usage:</p>
<div class="highlight-bash"><div class="highlight"><pre>usage: imglss-mpi-select-objects.py [-h] [--use-tractor-depth] [--conf CONF]
                                    {MYBGS,ELG,QSOC,LRG,QSO,QSOd,BGS} output

positional arguments:
  {MYBGS,ELG,QSOC,LRG,QSO,QSOd,BGS}
  output                Output file name. A new object catalogue file will be
                        created.

optional arguments:
  -h, --help            show this help message and exit
  --use-tractor-depth   Use Tractor&#39;s Depth in the catalogue, very fast!
  --conf CONF           Path to the imaginglss config file, default is from
                        DECALS_PY_CONFIG
</pre></div>
</div>
<p>Here is an example job script we use on Edison to generate the LRG catalogue.
Submit the job script with <code class="code docutils literal"><span class="pre">sbatch</span></code>. We also encourage typing in the commands
one by one from an interactive job session, obtained via <code class="code docutils literal"><span class="pre">salloc</span></code>. Refer to
<a href="#id1"><span class="problematic" id="id2">`http://www.nersc.gov/users/computational-systems/cori/running-jobs/interactive-jobs/`_</span></a>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c">#SBATCH -J imglss-mpi-select-objects</span>
<span class="c">#SBATCH -n 512</span>
<span class="c">#SBATCH -o imglss-mpi-select-objects.%j</span>
<span class="c">#SBATCH -p debug</span>
<span class="c">#SBATCH -t 00:30:00</span>

<span class="nb">export </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span>1

module load python/2.7-anaconda
<span class="nb">source</span> /project/projectdirs/m779/python-mpi/nersc/activate.sh

<span class="c"># change the following line to where your imaginglss is installed</span>
mirror ~/source/imaginglss imaginglss scripts

<span class="c"># use without installing</span>
<span class="nb">export </span><span class="nv">PYTHONPATH</span><span class="o">=</span>/dev/shm/local:<span class="nv">$PYTHONPATH</span>

<span class="c"># change conf to your imaginglss configuration file</span>
srun -n <span class="m">256</span> python-mpi /dev/shm/local/scripts/imglss-mpi-select-objects.py LRG LRG.hdf5 --conf /project/projectdirs/m779/imaginglss/dr2.conf.py
</pre></div>
</div>
</div>
<div class="section" id="generating-complete-random-sky-mask">
<h2>Generating Complete Random Sky Mask<a class="headerlink" href="#generating-complete-random-sky-mask" title="Permalink to this headline">¶</a></h2>
<p>imglss-mpi-make-random.py generates the randoms for the sky mask. The points will be uniform within the survey footprint.</p>
<p>The inline help of the script describes the usage:</p>
<div class="highlight-bash"><div class="highlight"><pre>usage: imglss-mpi-make-random.py <span class="o">[</span>-h<span class="o">]</span>
                      <span class="o">[</span>--conf CONF<span class="o">]</span>
                      Nran output

positional arguments:
  Nran                  Minimum number of randoms
  output

optional arguments:
  -h, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>
  --conf CONF           Path to the imaginglss config file, default is from
                        DECALS_PY_CONFIG
</pre></div>
</div>
<p>Here is an example job script we use on Edison to generate a QSO random catalogue.
Submit the job script with <code class="code docutils literal"><span class="pre">sbatch</span></code>. We also encourage typing in the commands
one by one from an interactive job session, obtained via <code class="code docutils literal"><span class="pre">salloc</span></code>. Refer to
<a href="#id3"><span class="problematic" id="id4">`http://www.nersc.gov/users/computational-systems/cori/running-jobs/interactive-jobs/`_</span></a>.</p>
<div class="code highlight-python"><div class="highlight"><pre>#!/bin/bash

#SBATCH -J imglss-mpi-make-random
#SBATCH -n 512
#SBATCH -o imglss-mpi-make-random.%j
#SBATCH -p debug
#SBATCH -t 00:30:00

export OMP_NUM_THREADS=1

module load python/2.7-anaconda
source /project/projectdirs/m779/python-mpi/nersc/activate.sh

# change the following line to where your imaginglss is installed
mirror ~/source/imaginglss imaginglss scripts

# use without installing
export PYTHONPATH=/dev/shm/local:$PYTHONPATH

# change conf to your imaginglss configuration file
srun -n 256 python-mpi /dev/shm/local/scripts/imglss-mpi-make-random.py 6000000 QSO-random.hdf5 --conf /project/projectdirs/m779/imaginglss/dr2.conf.py
</pre></div>
</div>
<p>Sometimes the position of a random catalogue is already specified. In this case we provide
another script, <cite>imglss-mpi-query-depth.py</cite>, to query the depth / noise level of the deccals survey of these points.
The RA and DEC of these points must be stored as two datasets name &#8216;RA&#8217; and &#8216;DEC&#8217; in a HDF5 file. Here is the help of
the script:</p>
<div class="code highlight-python"><div class="highlight"><pre>usage: imglss-mpi-query-depth.py [-h] [--conf CONF] query

Query Depth from DECALS data for input RA DEC of points. The input must be
saved in a HDF5 with two datasets &#39;RA&#39; and &#39;DEC&#39;. The output will be written
in the same file as INTRINSIC_NOISELEVEL data set. To lookup the columns, use
the dictionary in `imaginglss.model.dataproduct.bands`. The output of this
script can be directly fed into imglss-query-completeness.py as the query
input.

positional arguments:
  query        An HDF5 file with RA and DEC dataset, the position of to query
               the depth.

optional arguments:
  -h, --help   show this help message and exit
  --conf CONF  Path to the imaginglss config file, default is from
               DECALS_PY_CONFIG
</pre></div>
</div>
</div>
<div class="section" id="apply-star-veto-mask">
<h2>Apply Star veto mask<a class="headerlink" href="#apply-star-veto-mask" title="Permalink to this headline">¶</a></h2>
<p>imglss-query-tycho-veto.py applies the bright star veto masks to a target or random catalogue. The veto types are defined
in imaginglss/analysis/tycho_veto.py . As you can tell, we currently only support vetoing via a Tycho2 catalogue.</p>
<p>The star veto mask is important for correctly building the completeness estimator.</p>
<p>The inline help of the script describes the usage:</p>
<div class="code highlight-python"><div class="highlight"><pre>usage: imglss-query-tycho-veto.py [-h] [--conf CONF] catalogue

Query the TYCHOVETO flags of input data. The position is taken from the NOISES
extension of input. The result is written to the TYCHOVETO extension of
output. Currently, only veto by proximity to tycho stars are implemented. Each
veto in imaginglss.analysis.tycho_veto is calculated as a column in the
TYCHOVETO extension. Unfortunately, this script is not sufficiently smart to
decide the correct TYCHOVETO for the target type. Therefore, no combined veto
flag is generated.

positional arguments:
  catalogue    HDF5 catalogue file, can be either random or objects.
               TYCHO_VETO dataset will be added

optional arguments:
  -h, --help   show this help message and exit
  --conf CONF  Path to the imaginglss config file, default is from
               DECALS_PY_CONFIG
</pre></div>
</div>
</div>
<div class="section" id="query-completeness">
<h2>Query Completeness<a class="headerlink" href="#query-completeness" title="Permalink to this headline">¶</a></h2>
<p>imglss-query-completeness.py esitmates the fractional completeness for objects / randoms based on their depth.
A threshold confidence level is used to generate a 100% complete sample based on an object catalogue. Then
this sample is taken to model the fractional completeness. The result is appended as COMPLETENESS column to the
catalogue.</p>
<p>The inline help of the script describes the usage:</p>
<div class="code highlight-python"><div class="highlight"><pre>Usage: imglss-query-completeness.py [-h]
                                    [--use-tycho-veto {BOSS_DR9,DECAM_BGS,DECAM_ELG,DECAM_LRG,DECAM_QSO}]
                                    [--sigma-z SIGMA_Z] [--sigma-g SIGMA_G]
                                    [--sigma-r SIGMA_R] [--conf CONF]
                                    {MYBGS,ELG,QSOC,LRG,QSO,QSOd,BGS} objects
                                    query

positional arguments:
  {MYBGS,ELG,QSOC,LRG,QSO,QSOd,BGS}
  objects               object catalogue for building the completeness model.
  query                 catalogue to query completeness

optional arguments:
  -h, --help            show this help message and exit
  --use-tycho-veto {BOSS_DR9,DECAM_BGS,DECAM_ELG,DECAM_LRG,DECAM_QSO}
  --sigma-z SIGMA_Z
  --sigma-g SIGMA_G
  --sigma-r SIGMA_R
  --conf CONF           Path to the imaginglss config file, default is from
                        DECALS_PY_CONFIG
</pre></div>
</div>
</div>
<div class="section" id="assemble-final-product">
<h2>Assemble Final Product<a class="headerlink" href="#assemble-final-product" title="Permalink to this headline">¶</a></h2>
<p>imglss-export-text.py assembles a final catalogue for objects or randoms. The final product is a plain text file.
fluxes (only for objects) and depths of selected bands can be included in the final product.</p>
<p>We need a threshold confidence level (usually identical to the one used in imglss-query-completenesss) to filter
out poorly detected objects.</p>
<p>Vetoing by proximity to stars is also applied at this final stage.</p>
<p>The inline help of the script describes the usage:</p>
<div class="code highlight-python"><div class="highlight"><pre>usage: imglss-export-text.py [-h] [--conf CONF]
                         [--use-tycho-veto {BOSS_DR9,DECAM_BGS,DECAM_ELG,DECAM_LRG,DECAM_QSO}]
                         [--bands {Y,W4,r,u,W1,g,i,W3,z,W2} [{Y,W4,r,u,W1,g,i,W3,z,W2} ...]]
                         [--sigma-z SIGMA_Z] [--sigma-g SIGMA_G]
                         [--sigma-r SIGMA_R]
                         catalogue output

positional arguments:
  catalogue             internal catalogue of HDF5 type.
  output                text file to store the catalogue.

optional arguments:
  -h, --help            show this help message and exit
  --conf CONF           Path to the imaginglss config file, default is from
                        DECALS_PY_CONFIG
  --use-tycho-veto {BOSS_DR9,DECAM_BGS,DECAM_ELG,DECAM_LRG,DECAM_QSO}
  --bands {Y,W4,r,u,W1,g,i,W3,z,W2} [{Y,W4,r,u,W1,g,i,W3,z,W2} ...]
  --sigma-z SIGMA_Z
  --sigma-g SIGMA_G
  --sigma-r SIGMA_R
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Usage: Data Pipeline</a><ul>
<li><a class="reference internal" href="#building-the-cache">Building the Cache</a></li>
<li><a class="reference internal" href="#generating-object-catalogue">Generating Object Catalogue</a></li>
<li><a class="reference internal" href="#generating-complete-random-sky-mask">Generating Complete Random Sky Mask</a></li>
<li><a class="reference internal" href="#apply-star-veto-mask">Apply Star veto mask</a></li>
<li><a class="reference internal" href="#query-completeness">Query Completeness</a></li>
<li><a class="reference internal" href="#assemble-final-product">Assemble Final Product</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install.html"
                        title="previous chapter">Installation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="datamodel.html"
                        title="next chapter">Data Model</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/datapipeline.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="datamodel.html" title="Data Model"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ImagingLSS 0.9 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Yu Feng, Martin White.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>